# include "ad7705.h"

#define SOFT_SPI		


#define __CH1_GAIN_BIPOLAR_BUF	(GAIN_1 | UNIPOLAR | BUF_EN)
#define __CH2_GAIN_BIPOLAR_BUF	(GAIN_1 | UNIPOLAR | BUF_EN)

/*										
	

    ad7705???   STC89C52??????
      VCC   ------  5.0V (3.3V)
      GND   ------  GND
      CS    ------  P1.0
      RST   ------  P1.1   
      DIN   ------  P1.2
	  SCK   ------  P1.3
      DOUT  ------  P1.4
      DRDY  ------  P1.5        
*/

	sbit CS     = P1^0;
	sbit RESET  = P1^1;
	sbit DIN    = P1^2;
	sbit SCK    = P1^3;
	sbit DOUT   = P1^4;
	sbit DRDY	= P1^5;


	#define CS_0()		CS = 0
	#define CS_1()		CS = 1

	#define RESET_0()	RESET = 0
	#define RESET_1()	RESET = 1

	#define DI_0()		DIN = 0
	#define DI_1()		DIN = 1

	#define SCK_0()		SCK = 0 
	#define SCK_1()		SCK = 1

	#define DO_IS_HIGH()	(DOUT != 0)

	#define DRDY_IS_LOW()	(DRDY == 0)




enum
{
	
	REG_COMM	= 0x00,
	REG_SETUP	= 0x10,
	REG_CLOCK	= 0x20,	
	REG_DATA	= 0x30,	
	REG_ZERO_CH1	= 0x60,	
	REG_FULL_CH1	= 0x70,	
	REG_ZERO_CH2	= 0x61,	
	REG_FULL_CH2	= 0x71,	

	/* ??��???? */
	WRITE 		= 0x00,	/* ��???? */
	READ 		= 0x08,	/* ?????? */

	/* ??? */
	CH_1		= 0,	/* AIN1+  AIN1- */
	CH_2		= 1,	/* AIN2+  AIN2- */
	CH_3		= 2,	/* AIN1-  AIN1- */
	CH_4		= 3		/* AIN1-  AIN2- */
};

/* ???��????bit???? */
enum
{
	MD_NORMAL		= (0 << 6),	/* ?????? */
	MD_CAL_SELF		= (1 << 6),	/* ??��??? */
	MD_CAL_ZERO		= (2 << 6),	/* ��?0????? */
	MD_CAL_FULL		= (3 << 6),	/* ��???????? */

	GAIN_1			= (0 << 3),	/* ???? */
	GAIN_2			= (1 << 3),	/* ???? */
	GAIN_4			= (2 << 3),	/* ???? */
	GAIN_8			= (3 << 3),	/* ???? */
	GAIN_16			= (4 << 3),	/* ???? */
	GAIN_32			= (5 << 3),	/* ???? */
	GAIN_64			= (6 << 3),	/* ???? */
	GAIN_128		= (7 << 3),	/* ???? */

	/* ????????????????????????��?????????????????????????????????????????��??? */
	BIPOLAR			= (0 << 2),	/* ????????? */
	UNIPOLAR		= (1 << 2),	/* ?????????? */

	BUF_NO			= (0 << 1),	/* ????????��???????????????) */
	BUF_EN			= (1 << 1),	/* ?????��??? (?????????????) */

	FSYNC_0			= 0,
	FSYNC_1			= 1		/* ?????? */
};

/* ???????bit???? */
enum
{
	CLKDIS_0	= 0x00,		/* ????????? ?????????????????????????? */
	CLKDIS_1	= 0x10,		/* ????? ???????????????????��??????MCK_OUT??????????????? */

	/*
		2.4576MHz??CLKDIV=0 ????? 4.9152MHz ??CLKDIV=1 ????CLK ??? ??0????
		1MHz ??CLKDIV=0 ???? 2MHz   ??CLKDIV=1 ????CLK ??��???  ??1??
	*/
	CLK_4_9152M = 0x08,
	CLK_2_4576M = 0x00,
	CLK_1M 		= 0x04,
	CLK_2M 		= 0x0C,

	FS_50HZ		= 0x00,
	FS_60HZ		= 0x01,
	FS_250HZ	= 0x02,
	FS_500HZ	= 0x04,

	/*
		???????????????????ad7705 ????????
			??????????? 2.4576MHz ????????�q?????????? 84H,?????????????????10Hz,???0.1S ?????????????
			??????????? 1MHz ????????�q??????????80H, ?????????????????4Hz, ???0.25S ????????????
	*/
	ZERO_0		= 0x00,
	ZERO_1		= 0x80
};

static void ad7705_SyncSPI(void);
static void ad7705_Send8Bit(u8 _data);
static u8 ad7705_Recive8Bit(void);
static void ad7705_WriteByte(u8 _data);
static void ad7705_Write3Byte(u32 _data);
static u8 ad7705_ReadByte(void);
static u16 ad7705_Read2Byte(void);
static u32 ad7705_Read3Byte(void);
static void ad7705_WaitDRDY(void);
static void ad7705_ResetHard(void);

/*
*********************************************************************************************************
*	?? ?? ??: bsp_Initad7705
*	???????: ????Sad32??GPIO??SPI???????????? ad7705
*	??    ??: ??
*	?? ?? ?: ??
*********************************************************************************************************
*/
void ad7705_init(void)
{
#ifdef SOFT_SPI		/* ????SPI */
	/* ????REST??????????????????????? */

	/* ????CS??????????????????????? */

	/* ????SCK??????????????????????? */

	/* ????DIN??????????????????????? */

	/* ????DOUT????????????? */

	/* ????DOUT??????????????? */
#endif

	delay_ms(10);

	ad7705_ResetHard();		/* ?????�� */

	/*
		???????��???????????????DIN ??????��??????????????????????? 32????????????????
		ad7705 ?????????????
	*/
	delay_ms(5);

	ad7705_SyncSPI();		/* ???SPI?????? */

	delay_ms(5);

	/* ??????????? */
	ad7705_WriteByte(REG_CLOCK | WRITE | CH_1);			/* ??��????????????????��??????? */

	ad7705_WriteByte(CLKDIS_0 | CLK_4_9152M | FS_50HZ);	/* ???????50Hz */
	//ad7705_WriteByte(CLKDIS_0 | CLK_4_9152M | FS_500HZ);	/* ???????500Hz */

	/* ??????????????��? */
	ad7705_calib(1);	/* ?????��? CH1 */
	delay_ms(5);
}


/*
*********************************************************************************************************
*	?? ?? ??: ad7705_ResetHard
*	???????: ?????�� ad7705��?
*	??    ??: ??
*	?? ?? ?: ??
*********************************************************************************************************
*/
static void ad7705_ResetHard(void)
{
	RESET_1();
	delay_ms(1);
	RESET_0();
	delay_ms(2);
	RESET_1();
	delay_ms(1);
}

/*
*********************************************************************************************************
*	?? ?? ??: ad7705_SyncSPI
*	???????: ???ad7705��?SPI??????
*	??    ??: ??
*	?? ?? ?: ??
*********************************************************************************************************
*/
static void ad7705_SyncSPI(void)
{
	/* AD7705???��????????�٦�????��??????500us????? */
	CS_0();
	ad7705_Send8Bit(0xFF);
	ad7705_Send8Bit(0xFF);
	ad7705_Send8Bit(0xFF);
	ad7705_Send8Bit(0xFF);
	CS_1();
}

/*
*********************************************************************************************************
*	?? ?? ??: ad7705_Send8Bit
*	???????: ??SPI???????8??bit????? ????CS?????
*	??    ??: _data : ????
*	?? ?? ?: ??
*********************************************************************************************************
*/
static void ad7705_Send8Bit(u8 _data)
{
	u8 i;

	for(i = 0; i < 8; i++)
	{
		if (_data & 0x80)
		{
			DI_1();
		}
		else
		{
			DI_0();
		}
		SCK_0();
		_data <<= 1;
		delay1us();
		SCK_1();
		delay1us();
	}
}

/*
*********************************************************************************************************
*	?? ?? ??: ad7705_Recive8Bit
*	???????: ??SPI???????8??bit????? ????CS?????
*	??    ??: ??
*	?? ?? ?: ??
*********************************************************************************************************
*/
static u8 ad7705_Recive8Bit(void)
{
	u8 i;
	u8 read = 0;

	for (i = 0; i < 8; i++)
	{
		SCK_0();
		delay1us();
		read = read<<1;
		if (DO_IS_HIGH())
		{
			read++;
		}
		SCK_1();
		delay1us();
	}
	return read;
}

/*
*********************************************************************************************************
*	?? ?? ??: ad7705_WriteByte
*	???????: ��??1????????CS????
*	??    ??: _data ?????��???????
*	?? ?? ?: ??
*********************************************************************************************************
*/
static void ad7705_WriteByte(u8 _data)
{
	CS_0();
	ad7705_Send8Bit(_data);
	CS_1();
}

/*
*********************************************************************************************************
*	?? ?? ??: ad7705_Write3Byte
*	???????: ��??3????????CS????
*	??    ??: _data ?????��???????
*	?? ?? ?: ??
*********************************************************************************************************
*/
static void ad7705_Write3Byte(u32 _data)
{
	CS_0();
	ad7705_Send8Bit((_data >> 16) & 0xFF);
	ad7705_Send8Bit((_data >> 8) & 0xFF);
	ad7705_Send8Bit(_data);
	CS_1();
}

/*
*********************************************************************************************************
*	?? ?? ??: ad7705_ReadByte
*	???????: ??AD��??????????16��??
*	??    ??: ??
*	?? ?? ?: ????????16��??
*********************************************************************************************************
*/
static u8 ad7705_ReadByte(void)
{
	u8 read;

	CS_0();
	read = ad7705_Recive8Bit();
	CS_1();

	return read;
}

/*
*********************************************************************************************************
*	?? ?? ??: ad7705_Read2Byte
*	???????: ??2???????
*	??    ??: ??
*	?? ?? ?: ??????????16��??
*********************************************************************************************************
*/
static u16 ad7705_Read2Byte(void)
{
	u16 read;

	CS_0();
	read = ad7705_Recive8Bit();
	read <<= 8;
	read += ad7705_Recive8Bit();
	CS_1();

	return read;
}

/*
*********************************************************************************************************
*	?? ?? ??: ad7705_Read3Byte
*	???????: ??3???????
*	??    ??: ??
*	?? ?? ?: ????????????24bit) ??8��????0.
*********************************************************************************************************
*/
static u32 ad7705_Read3Byte(void)
{
	u32 read;

	CS_0();
	read = ad7705_Recive8Bit();
	read <<= 8;
	read += ad7705_Recive8Bit();
	read <<= 8;
	read += ad7705_Recive8Bit();
	CS_1();
	return read;
}

/*
*********************************************************************************************************
*	?? ?? ??: ad7705_WaitDRDY
*	???????: ????????????��? ??��????????????????
*	??    ??: ??
*	?? ?? ?: ??
*********************************************************************************************************
*/
static void ad7705_WaitDRDY(void)
{
	u32 i;

	for (i = 0; i < 8000; i++)
	{
		if (DRDY_IS_LOW())
		{
			break;
		}
	}
	if (i >= 8000)
	{
		ad7705_SyncSPI();		/* ???SPI?????? */
		delay_ms(5);
	}
}

/*
*********************************************************************************************************
*	?? ?? ??: ad7705_WriteReg
*	???????: ��?????????
*	??    ??:  _RegID : ?????ID
*			  _RegValue : ???????? ????8��?????????32��?�¦�??8bit
*	?? ?? ?: ??
*********************************************************************************************************
*/
void ad7705_WriteReg(u8 _RegID, u32 _RegValue)
{
	u8 bits;

	switch (_RegID)
	{
		case REG_COMM:		/* ??????? */
		case REG_SETUP:		/* ???��???? 8bit */
		case REG_CLOCK:		/* ??????? 8bit */
			bits = 8;
			break;

		case REG_ZERO_CH1:	/* CH1 ??????? 24bit */
		case REG_FULL_CH1:	/* CH1 ?????????? 24bit */
		case REG_ZERO_CH2:	/* CH2 ??????? 24bit */
		case REG_FULL_CH2:	/* CH2 ?????????? 24bit*/
			bits = 24;
			break;

		case REG_DATA:		/* ???????? 16bit */
		default:
			return;
	}

	ad7705_WriteByte(_RegID | WRITE);	/* ��???????, ??????????��???????????��???????? */

	if (bits == 8)
	{
		ad7705_WriteByte((u8)_RegValue);
	}
	else	/* 24bit */
	{
		ad7705_Write3Byte(_RegValue);
	}
}

/*
*********************************************************************************************************
*	?? ?? ??: ad7705_ReadReg
*	???????: ��?????????
*	??    ??:  _RegID : ?????ID
*			  _RegValue : ???????? ????8��?????????32��?�¦�??8bit
*	?? ?? ?: ????????????? ????8��?????????32��?�¦�??8bit
*********************************************************************************************************
*/
u32 ad7705_ReadReg(u8 _RegID)
{
	u8 bits;
	u8 read;

	switch (_RegID)
	{
		case REG_COMM:		/* ??????? */
		case REG_SETUP:		/* ???��???? 8bit */
		case REG_CLOCK:		/* ??????? 8bit */
			bits = 8;
			break;

		case REG_ZERO_CH1:	/* CH1 ??????? 24bit */
		case REG_FULL_CH1:	/* CH1 ?????????? 24bit */
		case REG_ZERO_CH2:	/* CH2 ??????? 24bit */
		case REG_FULL_CH2:	/* CH2 ?????????? 24bit*/
			bits = 24;
			break;

		case REG_DATA:		/* ???????? 16bit */
		default:
			return 0xFFFFFFFF;
	}

	ad7705_WriteByte(_RegID | READ);	/* ��???????, ??????????��???????????��???????? */

	if (bits == 16)
	{
		read = ad7705_Read2Byte();
	}
	else if (bits == 8)
	{
		read = ad7705_ReadByte();
	}
	else	/* 24bit */
	{
		read = ad7705_Read3Byte();
	}
	return read;
}

/*
*********************************************************************************************************
*	?? ?? ??: ad7705_CalibSelf
*	???????: ??????��?. ?????????AIN+ AIN-��?0��?????????Vref ��???��?????????��???????
*			  ???? 180ms
*	??    ??:  _ch : ADC?????1??2
*	?? ?? ?: ??
*********************************************************************************************************
*/
void ad7705_calib(u8 _ch)
{
	if (_ch == 1)
	{
		/* ??��?CH1 */
		ad7705_WriteByte(REG_SETUP | WRITE | CH_1);	/* ��????????????????��???��?????????1 */
		ad7705_WriteByte(MD_CAL_SELF | __CH1_GAIN_BIPOLAR_BUF | FSYNC_0);/* ??????��? */
		ad7705_WaitDRDY();	/* ????????????? --- ????????180ms */
	}
	else if (_ch == 2)
	{
		/* ??��?CH2 */
		ad7705_WriteByte(REG_SETUP | WRITE | CH_2);	/* ��????????????????��???��?????????2 */
		ad7705_WriteByte(MD_CAL_SELF | __CH2_GAIN_BIPOLAR_BUF | FSYNC_0);	/* ??????��? */
		ad7705_WaitDRDY();	/* ?????????????  --- ????????180ms */
	}
}

/*
*********************************************************************************************************
*	?? ?? ??: ad7705_SytemCalibZero
*	???????: ??????��???��. ??AIN+ AIN-??????�ڨ�?????��????????????????????��???????
*			 ????????????? ad7705_ReadReg(REG_ZERO_CH1) ??  ad7705_ReadReg(REG_ZERO_CH2) ???��???????
*	??    ??: _ch : ADC?????1??2
*	?? ?? ?: ??
*********************************************************************************************************
*/
void ad7705_SytemCalibZero(u8 _ch)
{
	if (_ch == 1)
	{
		/* ��?CH1 */
		ad7705_WriteByte(REG_SETUP | WRITE | CH_1);	/* ��????????????????��???��?????????1 */
		ad7705_WriteByte(MD_CAL_ZERO | __CH1_GAIN_BIPOLAR_BUF | FSYNC_0);/* ??????��? */
		ad7705_WaitDRDY();	/* ????????????? */
	}
	else if (_ch == 2)
	{
		/* ��?CH2 */
		ad7705_WriteByte(REG_SETUP | WRITE | CH_2);	/* ��????????????????��???��?????????1 */
		ad7705_WriteByte(MD_CAL_ZERO | __CH2_GAIN_BIPOLAR_BUF | FSYNC_0);	/* ??????��? */
		ad7705_WaitDRDY();	/* ????????????? */
	}
}

/*
*********************************************************************************************************
*	?? ?? ??: ad7705_SytemCalibFull
*	???????: ??????��???��. ??AIN+ AIN-????????????????�ڨ�?????��????????????????????��???????
*			 ????????????? ad7705_ReadReg(REG_FULL_CH1) ??  ad7705_ReadReg(REG_FULL_CH2) ???��???????
*	??    ??:  _ch : ADC?????1??2
*	?? ?? ?: ??
*********************************************************************************************************
*/
void ad7705_SytemCalibFull(u8 _ch)
{
	if (_ch == 1)
	{
		/* ��?CH1 */
		ad7705_WriteByte(REG_SETUP | WRITE | CH_1);	/* ��????????????????��???��?????????1 */
		ad7705_WriteByte(MD_CAL_FULL | __CH1_GAIN_BIPOLAR_BUF | FSYNC_0);/* ??????��? */
		ad7705_WaitDRDY();	/* ????????????? */
	}
	else if (_ch == 2)
	{
		/* ��?CH2 */
		ad7705_WriteByte(REG_SETUP | WRITE | CH_2);	/* ��????????????????��???��?????????1 */
		ad7705_WriteByte(MD_CAL_FULL | __CH2_GAIN_BIPOLAR_BUF | FSYNC_0);	/* ??????��? */
		ad7705_WaitDRDY();	/* ????????????? */
	}
}

/*
*********************************************************************************************************
*	?? ?? ??: ad7705_ReadAdc1
*	???????: ?????1??2??ADC????
*	??    ??: ??
*	?? ?? ?: ??
*********************************************************************************************************
*/
u16 ad7705_ReadAdc(u8 _ch)
{
	u8 i;
	u16 read = 0;

	/* ??????????��????????��????2?? */
	for (i = 0; i < 2; i++)
	{
		ad7705_WaitDRDY();		/* */

		if (_ch == 1)
		{
			ad7705_WriteByte(0x38);
		}
		else if (_ch == 2)
		{
			ad7705_WriteByte(0x39);
		}

		read = ad7705_Read2Byte();
	}
	return read;
}

/***************************** ?????????? www.armfly.com (END OF FILE) *********************************/
